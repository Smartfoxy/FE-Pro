<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>promise</title>
    <style>
        .showMore {
            margin: 10px;
            padding: 5px;
        }
        .ship {
            cursor: pointer;
        }
        .films {
           display: block;
        }
        .invisible {
            display: none;
        }
        
        
    </style>

</head>

<body>

    <ul class = 'ships'></ul>
    <button class = 'showMore'>Show more</button>
    

    <script>
        "use strict"

        const $shipsList = document.querySelector('.ships');
        let currentLinkShips = 'https://swapi.dev/api/starships';
        let linkFilms = 'https://swapi.dev/api/films/';
        const $showMore = document.querySelector('.showMore');
        

        loadShips(getSWShips(currentLinkShips));

        $showMore.addEventListener('click', function() {
             if(currentLinkShips) {
                loadShips(getSWShips(currentLinkShips));
             }
        })

        function loadShips(ships) { 
            ships.then(function(ships){
                let shipTitles = ships.map(ship =>{
                    return ship.title;
                })
               
                shipTitles.forEach(item => {
                    const $item = document.createElement('li');
                    $item.classList.add('ship');
                    $item.innerHTML = item;
                    $shipsList.append($item);
                
                
                    $item.addEventListener('click', function(ship) {

                        if(!$item.firstElementChild) {
                            
                            let filmsUrlarr = ships.find(ship => {
                                return ship.title === $item.firstChild.textContent;
                            }).filmsUrl;

                            let filmsArr = filmsUrlarr.map(url => {
                                return getSWFilmTitle(url);
                            })
                            Promise.all([ships, filmsArr])
                            .then(data => {
                                let $filmList = createFilmList(data[1]);
                                $item.append($filmList);
                            })
                        } else {
                            $item.querySelector('.films').classList.toggle('invisible');
                        }
                    })
                })
            })
        }  

        function createFilmList(filmsArr) {
            const $filmList = document.createElement('ul');
            $filmList.classList.add('films');

            Promise.all(filmsArr)
                .then(filmsArr => {
                    fillList($filmList, filmsArr, 'film');
                })
            
            return $filmList;
        }    

        function fillList($list, itemsArray, itemClass) {
            itemsArray.forEach(item => {
                const $item = document.createElement('li');
                $item.classList.add(itemClass);
                $item.innerHTML = item;
                $list.append($item);
            })
        } 

        function getSWShips(link) {
            return fetch(link)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    let ships = [];

                    data.results.forEach(ship => {
                        ships.push(
                            {
                            'title': ship.name,
                            'filmsUrl': ship.films
                            }
                        );
                    });

                    currentLinkShips = data.next;
                    if(!currentLinkShips) $showMore.disabled = true;
                    return ships;
                })
        }

        function getSWFilmTitle(link) {
            return fetch(link)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    return data.title; 
                })
        }


    </script>
</body>

</html> 